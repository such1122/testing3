<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Brake Systems Development Scheduling Dashboard (User/Admin Views)</title>

    <!-- Google Font (Roboto) - open source -->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet"
    />

    <!-- FullCalendar CSS/JS (MIT-licensed) from CDN to ensure the calendar renders -->
    <link
        href="https://unpkg.com/fullcalendar@5.10.1/main.min.css"
        rel="stylesheet"
    />
    <script src="https://unpkg.com/fullcalendar@5.10.1/main.min.js"></script>

    <style>
        /* Global resets & font */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        h1, h2 {
            font-weight: 700;
            color: #444;
            margin-bottom: 10px;
            position: relative;
        }
        /* Subtle underline animation under headers */
        h1::after, h2::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: -4px;
            width: 0;
            height: 3px;
            background-color: #007bff;
            transition: width 0.3s ease-in-out;
        }
        h1:hover::after, h2:hover::after {
            width: 50px;
        }

        /* Container cards */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        /* Button styling */
        button, input[type="submit"] {
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            padding: 10px 16px;
            transition: background-color 0.2s ease-in-out;
        }
        button:hover, input[type="submit"]:hover {
            background-color: #0056b3;
        }

        /* Tool list styling */
        .tool-lists {
            display: flex;
            gap: 20px;
        }
        .tool-lists .tool-card {
            flex: 1;
        }
        ul {
            list-style: none;
            padding-left: 0;
        }
        ul li {
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
            padding: 8px 12px;
            transition: background-color 0.2s;
        }
        ul li:hover {
            background-color: #e9e9e9;
        }

        /* Form inputs */
        form label {
            display: block;
            font-weight: 500;
            margin-bottom: 4px;
        }
        form input[type="text"],
        form input[type="date"],
        form input[type="time"],
        form select,
        form textarea {
            border: 1px solid #ccc;
            border-radius: 4px;
            display: block;
            margin-bottom: 12px;
            padding: 8px;
            width: 100%;
            transition: border-color 0.2s;
        }
        form input[type="text"]:focus,
        form input[type="date"]:focus,
        form input[type="time"]:focus,
        form select:focus,
        form textarea:focus {
            border-color: #007bff;
            outline: none;
        }

        /* Calendar container */
        #calendar-card {
            margin-top: 20px;
        }
        #calendar {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 10px;
            background-color: #fff;
        }

        /* Admin section layout */
        .admin-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .admin-section .admin-card {
            flex: 1;
        }

        /* Download button container */
        .top-bar {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Title -->
    <h1>Scheduling Dashboard</h1>

    <!-- Top Bar: Download button aligned to the right -->
    <div class="top-bar">
        <button id="downloadSnapshotBtn">Download Weekly Snapshot</button>
    </div>

    <!-- Tool Availability Section -->
    <div class="card">
        <div class="tool-lists">
            <div class="tool-card">
                <h2>Tools</h2>
                <ul id="allTools"></ul>
            </div>
            <div class="tool-card">
                <h2>Unavailable Tools</h2>
                <ul id="unavailableTools"></ul>
            </div>
        </div>
    </div>

    <!-- Reservation Form (Card) -->
    <div class="card">
        <h2>Make a Reservation</h2>
        <form id="reservationForm">
            <div>
                <label for="member">Member Name:</label>
                <input type="text" id="member" name="member" required />
            </div>
            <div>
                <label for="tool">Select Tool:</label>
                <select id="tool" name="tool" required></select>
            </div>
            <div>
                <label for="date">Date:</label>
                <input type="date" id="date" name="date" required />
            </div>
            <div>
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" name="startTime" required />
            </div>
            <div>
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime" name="endTime" required />
            </div>
            <div>
                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes" required></textarea>
            </div>
            <div style="margin-top: 10px;">
                <input type="submit" value="Reserve Tool" />
            </div>
        </form>
    </div>

    <!-- Calendar View (Card) -->
    <div class="card" id="calendar-card">
        <h2>Calendar View</h2>
        <div id="calendar"></div>
    </div>

    <!-- Admin Section (hidden by default) -->
    <div id="adminSection" class="admin-section" style="display: none;">
        <div class="card admin-card">
            <h2>Add Tool</h2>
            <form id="toolForm">
                <div>
                    <label for="newTool">Tool Name:</label>
                    <input type="text" id="newTool" name="newTool" required />
                </div>
                <div style="margin-top: 10px;">
                    <input type="submit" value="Add Tool" />
                </div>
            </form>
        </div>
        <div class="card admin-card">
            <h2>Remove Tool</h2>
            <form id="removeToolForm">
                <div>
                    <label for="removeTool">Select Tool to Remove:</label>
                    <select id="removeTool" name="removeTool" required></select>
                </div>
                <div style="margin-top: 10px;">
                    <input type="submit" value="Remove Tool" />
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript: Authentication Logic + Calendar + CSV Download + Runtime Counter -->
    <script>
    // Prompt once, store result in a global
    var userEmail = prompt("Please enter your email:");

    document.addEventListener('DOMContentLoaded', function () {
        // Determine admin status once
        var admins = ["test123@gmail.com"];
        var isAdmin = userEmail && admins.includes(userEmail.trim().toLowerCase());
        if (isAdmin) {
            document.getElementById('adminSection').style.display = 'flex';
        }

        // 1) Initialize FullCalendar
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            events: []
        });
        calendar.render();

        // 2) Tool Data Structures
        var tools = ["Tool #1", "Tool #2", "Tool #3", "Tool #4"];

        // --- Runtime counter object (stores total usage per user, in ms) ---
        var userUsage = {};

        // 3) Determine Unavailable Tools at a Given Moment
        function getUnavailableToolsAt(momentInTime) {
            var overlapping = new Set();
            calendar.getEvents().forEach(function (event) {
                var parts = event.title.split(':');
                if (parts.length < 2) return;
                var toolAndNotes = parts[1].trim();       // e.g. "Tool #1 - some notes"
                var toolName = toolAndNotes.split(' - ')[0]; // e.g. "Tool #1"

                var evStart = event.start;
                var evEnd   = event.end;
                if (momentInTime >= evStart && momentInTime < evEnd) {
                    overlapping.add(toolName);
                }
            });
            return Array.from(overlapping);
        }

        // 4) Render "All Tools" and "Unavailable Tools" Lists
        function renderToolLists(unavailableNow) {
            var allToolsList         = document.getElementById('allTools');
            var unavailableToolsList = document.getElementById('unavailableTools');
            allToolsList.innerHTML         = '';
            unavailableToolsList.innerHTML = '';

            tools.forEach(function (tool) {
                var li = document.createElement('li');
                li.textContent = tool;
                if (unavailableNow.includes(tool)) {
                    unavailableToolsList.appendChild(li);
                } else {
                    allToolsList.appendChild(li);
                }
            });
        }

        // 5) Rebuild Tool-Selection Dropdown Based on Current Unavailability
        function renderToolDropdown(unavailableNow) {
            var toolDropdown = document.getElementById('tool');
            toolDropdown.innerHTML = '';
            tools.forEach(function (tool) {
                if (!unavailableNow.includes(tool)) {
                    var option = document.createElement('option');
                    option.value       = tool;
                    option.textContent = tool;
                    toolDropdown.appendChild(option);
                }
            });
        }

        // 6) Refresh Everything Based on "Now"
        function markCurrentlyUnavailableTools() {
            var now = new Date();
            var unavailableNow = getUnavailableToolsAt(now);
            renderToolLists(unavailableNow);
            renderToolDropdown(unavailableNow);
        }

        // 7) Check If a Tool Is Free During a User-Selected Window
        function checkToolAvailability(tool, start, end) {
            var events = calendar.getEvents();
            for (var i = 0; i < events.length; i++) {
                var event = events[i];
                if (event.title.includes(tool)) {
                    var evStart = event.start;
                    var evEnd   = event.end;
                    // Overlap check [start, end) vs [evStart, evEnd)
                    if ((start >= evStart && start < evEnd) ||
                        (end   > evStart && end   <= evEnd) ||
                        (start <= evStart && end   >= evEnd)) {
                        return false;
                    }
                }
            }
            return true;
        }

        // --- NEW FUNCTION: Check if a user already has an overlapping booking ---
        function isUserOverlapping(user, start, end) {
            var events = calendar.getEvents();
            for (var i = 0; i < events.length; i++) {
                var event = events[i];
                // Extract the user portion from the event title ("Alice: Tool #1 - notes")
                var existingUser = event.title.split(':')[0].trim();
                if (existingUser === user) {
                    var evStart = event.start;
                    var evEnd   = event.end;
                    // Overlap check [start, end) vs [evStart, evEnd)
                    if ((start >= evStart && start < evEnd) ||
                        (end   > evStart && end   <= evEnd) ||
                        (start <= evStart && end   >= evEnd)) {
                        return true;
                    }
                }
            }
            return false;
        }
        // --- END NEW FUNCTION ---

        // 8) "Add Reservation" Handler
        document.getElementById('reservationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            // All fields are required by HTML, so they must be filled.
            var member    = document.getElementById('member').value.trim();
            var tool      = document.getElementById('tool').value;
            var date      = document.getElementById('date').value;
            var startTime = document.getElementById('startTime').value;
            var endTime   = document.getElementById('endTime').value;
            var notes     = document.getElementById('notes').value.trim();

            var start = new Date(date + 'T' + startTime);
            var end   = new Date(date + 'T' + endTime);

            // --- CHECK: Prevent same user from holding two overlapping benches ---
            if (isUserOverlapping(member, start, end)) {
                alert('You already have a reservation at an overlapping time. Please choose a different time.');
                return;
            }
            // --- END CHECK ---

            if (checkToolAvailability(tool, start, end)) {
                calendar.addEvent({
                    title: member + ': ' + tool + ' - ' + notes,
                    start: date + 'T' + startTime,
                    end:   date + 'T' + endTime,
                    extendedProps: { notes: notes }
                });

                // --- UPDATE runtime counter for this user ---
                var durationMs = end.getTime() - start.getTime();
                if (!userUsage[member]) {
                    userUsage[member] = 0;
                }
                userUsage[member] += durationMs;
                // Log total usage in hours to console (rounded to two decimals)
                var hoursUsed = (userUsage[member] / (1000 * 60 * 60)).toFixed(2);
                console.log(member + ' total usage: ' + hoursUsed + ' hours');
                // --- END UPDATE ---

                // Recompute availability immediately
                markCurrentlyUnavailableTools();
                // Clear the form fields for next reservation
                document.getElementById('reservationForm').reset();
            } else {
                alert('Tool is unavailable during the selected time.');
            }
        });

        // 9) "Add Tool" (Admin) Handler (only if admin)
        if (isAdmin) {
            document.getElementById('toolForm').addEventListener('submit', function (e) {
                e.preventDefault();
                var newTool = document.getElementById('newTool').value.trim();
                if (newTool === '') {
                    alert('Tool name cannot be empty.');
                    return;
                }
                if (tools.includes(newTool)) {
                    alert('Tool with the same name already exists!');
                } else {
                    tools.push(newTool);
                    // After pushing, immediately update the lists and dropdown
                    markCurrentlyUnavailableTools();
                    updateRemoveToolDropdown();
                    // Clear the input field
                    document.getElementById('toolForm').reset();
                }
            });

            // 10) "Remove Tool" (Admin) Handler
            document.getElementById('removeToolForm').addEventListener('submit', function (e) {
                e.preventDefault();
                var toolToRemove = document.getElementById('removeTool').value;
                tools = tools.filter(t => t !== toolToRemove);
                // Also remove any calendar events for that tool
                calendar.getEvents().forEach(function (ev) {
                    if (ev.title.includes(toolToRemove)) {
                        ev.remove();
                    }
                });
                markCurrentlyUnavailableTools();
                updateRemoveToolDropdown();
            });
        }

        // 11) Keep the "Remove Tool" Dropdown in Sync (only for admin)
        function updateRemoveToolDropdown() {
            var removeDropdown = document.getElementById('removeTool');
            removeDropdown.innerHTML = '';
            tools.forEach(function (tool) {
                var option = document.createElement('option');
                option.value       = tool;
                option.textContent = tool;
                removeDropdown.appendChild(option);
            });
        }

        // 12) INITIALIZATION on Page Load
        markCurrentlyUnavailableTools();
        if (isAdmin) {
            updateRemoveToolDropdown();
        }
        // 13) Recompute Unavailability Every Minute
        setInterval(markCurrentlyUnavailableTools, 60 * 1000);

        // 14) "Download Snapshot CSV" Functionality (extended to include usage summary)
        function downloadSnapshotCSV() {
            var view      = calendar.view;
            var weekStart = view.activeStart;
            var weekEnd   = view.activeEnd;
            var eventsThisWeek = [];

            calendar.getEvents().forEach(function (ev) {
                var evStart = ev.start;
                if (evStart >= weekStart && evStart < weekEnd) {
                    eventsThisWeek.push(ev);
                }
            });

            eventsThisWeek.sort(function (a, b) {
                return a.start - b.start;
            });

            var csvRows = [];
            // Header row for individual reservations
            csvRows.push(['Member', 'Tool', 'Start DateTime', 'End DateTime', 'Notes'].join(','));

            // If no reservations, add a placeholder row
            if (eventsThisWeek.length === 0) {
                csvRows.push('No reservations this week,,,,');
            } else {
                // Build rows for each reservation
                function escapeForCSV(str) {
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }
                eventsThisWeek.forEach(function (ev) {
                    var parts       = ev.title.split(':');
                    var memberName  = parts[0].trim();
                    var toolAndNotes = parts[1].trim();
                    var toolName    = toolAndNotes.split(' - ')[0].trim();
                    var notes       = toolAndNotes.split(' - ')[1] || '';
                    var startStr    = ev.start.toLocaleString();
                    var endStr      = ev.end.toLocaleString();
                    csvRows.push([
                        escapeForCSV(memberName),
                        escapeForCSV(toolName),
                        escapeForCSV(startStr),
                        escapeForCSV(endStr),
                        escapeForCSV(notes)
                    ].join(','));
                });
            }

            // --- NEW: Build per-user usage totals for this week ---
            // Compute total duration per user (in ms)
            var usageMap = {};
            eventsThisWeek.forEach(function(ev) {
                var parts      = ev.title.split(':');
                var memberName = parts[0].trim();
                var startMs    = ev.start.getTime();
                var endMs      = ev.end.getTime();
                var durationMs = endMs - startMs;
                if (!usageMap[memberName]) {
                    usageMap[memberName] = 0;
                }
                usageMap[memberName] += durationMs;
            });

            // Add a blank row to separate the two sections
            csvRows.push(',,,,');
            // Header row for the usage summary
            csvRows.push(['Member', 'Total Hours This Week'].join(','));

            // Add one row per user with hours (rounded to two decimals)
            Object.keys(usageMap).forEach(function(user) {
                var hours = (usageMap[user] / (1000 * 60 * 60)).toFixed(2);
                csvRows.push([escapeForCSV(user), escapeForCSV(hours)].join(','));
            });
            // --- END NEW ---

            var csvString = csvRows.join('\r\n');
            var blob      = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            var filename  =
                'schedule_snapshot_' +
                weekStart.getFullYear().toString() +
                String(weekStart.getMonth() + 1).padStart(2, '0') +
                String(weekStart.getDate()).padStart(2, '0') +
                '.csv';

            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Hook up the "Download Snapshot" button
        document.getElementById('downloadSnapshotBtn').addEventListener('click', function () {
            downloadSnapshotCSV();
        });
    });
    </script>
</body>
</html>
