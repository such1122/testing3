<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brake Systems Development Scheduling Dashboard (User/Admin Views)</title>

  <!-- Google Font (Roboto) - open source -->
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />

  <!-- FullCalendar CSS/JS (MIT-licensed) from CDN -->
  <link
    href="https://unpkg.com/fullcalendar@5.10.1/main.min.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/fullcalendar@5.10.1/main.min.js"></script>

  <style>
    /* … (your existing CSS goes here) … */
  </style>
</head>
<body>
  <!-- ========================
       PROMPT-ONCE SCRIPT
       ======================== --> 
  <script>
    (function() {
      // 1) Check localStorage for “userEmail”
      var stored = window.localStorage.getItem('userEmail');

      if (stored && stored.trim() !== '') {
        // If we already have it, use that
        window.userEmail = stored;
      } else {
        // Otherwise, prompt once and save it
        var answer = prompt("Please enter your email:");
        if (answer && answer.trim() !== '') {
          window.localStorage.setItem('userEmail', answer.trim());
          window.userEmail = answer.trim();
        } else {
          // If canceled or blank, still store an empty string so we don't re-prompt
          window.localStorage.setItem('userEmail', "");
          window.userEmail = "";
        }
      }
    })();
  </script>

  <!-- Title -->
  <h1>Scheduling Dashboard</h1>

  <!-- Top Bar: Download button aligned to the right -->
  <div class="top-bar">
    <button id="downloadSnapshotBtn">Download Weekly Snapshot</button>
  </div>

  <!-- Tool Availability Section -->
  <div class="card">
    <div class="tool-lists">
      <div class="tool-card">
        <h2>Tools</h2>
        <ul id="allTools"></ul>
      </div>
      <div class="tool-card">
        <h2>Unavailable Tools</h2>
        <ul id="unavailableTools"></ul>
      </div>
    </div>
  </div>

  <!-- Reservation Form (Card) -->
  <div class="card">
    <h2>Make a Reservation</h2>
    <form id="reservationForm">
      <div>
        <label for="member">Member Name:</label>
        <input type="text" id="member" name="member" required />
      </div>
      <div>
        <label for="tool">Select Tool:</label>
        <select id="tool" name="tool" required></select>
      </div>
      <div>
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required />
      </div>
      <div>
        <label for="startTime">Start Time:</label>
        <input type="time" id="startTime" name="startTime" required />
      </div>
      <div>
        <label for="endTime">End Time:</label>
        <input type="time" id="endTime" name="endTime" required />
      </div>
      <div>
        <label for="notes">Notes:</label>
        <textarea id="notes" name="notes" required></textarea>
      </div>
      <div style="margin-top: 10px;">
        <input type="submit" value="Reserve Tool" />
      </div>
    </form>
  </div>

  <!-- Calendar View (Card) -->
  <div class="card" id="calendar-card">
    <h2>Calendar View</h2>
    <div id="calendar"></div>
  </div>

  <!-- Admin Section (hidden by default) -->
  <div id="adminSection" class="admin-section" style="display: none;">
    <div class="card admin-card">
      <h2>Add Tool</h2>
      <form id="toolForm">
        <div>
          <label for="newTool">Tool Name:</label>
          <input type="text" id="newTool" name="newTool" required />
        </div>
        <div style="margin-top: 10px;">
          <input type="submit" value="Add Tool" />
        </div>
      </form>
    </div>
    <div class="card admin-card">
      <h2>Remove Tool</h2>
      <form id="removeToolForm">
        <div>
          <label for="removeTool">Select Tool to Remove:</label>
          <select id="removeTool" name="removeTool" required></select>
        </div>
        <div style="margin-top: 10px;">
          <input type="submit" value="Remove Tool" />
        </div>
      </form>
    </div>
  </div>

  <!-- ========================
       MAIN SCRIPT (unchanged)
       ======================== --> 
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Now window.userEmail is already set (no re-prompt)
      var admins = ["test123@gmail.com"];
      var isAdmin = false;
      if (window.userEmail) {
        isAdmin = admins.includes(window.userEmail.trim().toLowerCase());
      }
      if (isAdmin) {
        document.getElementById('adminSection').style.display = 'flex';
      }

      // Initialize FullCalendar
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        events: []
      });
      calendar.render();

      // Tool data
      var tools = ["Tool #1", "Tool #2", "Tool #3", "Tool #4"];
      var userUsage = {}; // runtime counter

      //
      // LOCALSTORAGE HELPERS FOR EVENTS PERSISTENCE
      //
      function saveEventsToLocalStorage() {
        var all = calendar.getEvents();
        var plain = all.map(function(ev) {
          return {
            title: ev.title,
            start: ev.start.toISOString(),
            end: ev.end.toISOString()
          };
        });
        localStorage.setItem('reservations', JSON.stringify(plain));
      }

      function loadEventsFromLocalStorage() {
        var saved = localStorage.getItem('reservations');
        if (!saved) return;
        try {
          var arr = JSON.parse(saved);
          arr.forEach(function(obj) {
            calendar.addEvent({
              title: obj.title,
              start: obj.start,
              end: obj.end
            });
            // Also update userUsage for these loaded events
            var parts = obj.title.split(':');
            var memberName = parts[0].trim();
            var startDate = new Date(obj.start);
            var endDate = new Date(obj.end);
            var durationMs = endDate.getTime() - startDate.getTime();
            if (!userUsage[memberName]) {
              userUsage[memberName] = 0;
            }
            userUsage[memberName] += durationMs;
          });
        } catch (err) {
          console.error("Could not parse saved reservations:", err);
        }
      }

      //
      // TOOL AVAILABILITY LOGIC
      //
      function getUnavailableToolsAt(momentInTime) {
        var overlapping = new Set();
        calendar.getEvents().forEach(function (event) {
          var parts = event.title.split(':');
          if (parts.length < 2) return;
          var toolAndNotes = parts[1].trim();
          var toolName = toolAndNotes.split(' - ')[0];

          var evStart = event.start;
          var evEnd = event.end;
          if (momentInTime >= evStart && momentInTime < evEnd) {
            overlapping.add(toolName);
          }
        });
        return Array.from(overlapping);
      }

      function renderToolLists(unavailableNow) {
        var allToolsList = document.getElementById('allTools');
        var unavailableToolsList = document.getElementById('unavailableTools');
        allToolsList.innerHTML = '';
        unavailableToolsList.innerHTML = '';

        tools.forEach(function (tool) {
          var li = document.createElement('li');
          li.textContent = tool;
          if (unavailableNow.includes(tool)) {
            unavailableToolsList.appendChild(li);
          } else {
            allToolsList.appendChild(li);
          }
        });
      }

      function renderToolDropdown(unavailableNow) {
        var toolDropdown = document.getElementById('tool');
        toolDropdown.innerHTML = '';
        tools.forEach(function (tool) {
          if (!unavailableNow.includes(tool)) {
            var option = document.createElement('option');
            option.value = tool;
            option.textContent = tool;
            toolDropdown.appendChild(option);
          }
        });
      }

      function markCurrentlyUnavailableTools() {
        var now = new Date();
        var unavailableNow = getUnavailableToolsAt(now);
        renderToolLists(unavailableNow);
        renderToolDropdown(unavailableNow);
      }

      function checkToolAvailability(tool, start, end) {
        var events = calendar.getEvents();
        for (var i = 0; i < events.length; i++) {
          var event = events[i];
          if (event.title.includes(tool)) {
            var evStart = event.start;
            var evEnd = event.end;
            if ((start >= evStart && start < evEnd) ||
                (end > evStart && end <= evEnd) ||
                (start <= evStart && end >= evEnd)) {
              return false;
            }
          }
        }
        return true;
      }

      function isUserOverlapping(user, start, end) {
        var events = calendar.getEvents();
        for (var i = 0; i < events.length; i++) {
          var event = events[i];
          var existingUser = event.title.split(':')[0].trim();
          if (existingUser === user) {
            var evStart = event.start;
            var evEnd = event.end;
            if ((start >= evStart && start < evEnd) ||
                (end > evStart && end <= evEnd) ||
                (start <= evStart && end >= evEnd)) {
              return true;
            }
          }
        }
        return false;
      }

      // LOAD SAVED EVENTS ON PAGE LOAD
      loadEventsFromLocalStorage();
      markCurrentlyUnavailableTools();

      // RESERVATION FORM HANDLER
      document.getElementById('reservationForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var member = document.getElementById('member').value.trim();
        var tool = document.getElementById('tool').value;
        var date = document.getElementById('date').value;
        var startTime = document.getElementById('startTime').value;
        var endTime = document.getElementById('endTime').value;
        var notes = document.getElementById('notes').value.trim();

        var start = new Date(date + 'T' + startTime);
        var end = new Date(date + 'T' + endTime);

        if (isUserOverlapping(member, start, end)) {
          alert('You already have a reservation at an overlapping time.');
          return;
        }

        if (checkToolAvailability(tool, start, end)) {
          var newEvent = calendar.addEvent({
            title: member + ': ' + tool + ' - ' + notes,
            start: date + 'T' + startTime,
            end: date + 'T' + endTime,
            extendedProps: { notes: notes }
          });

          // UPDATE USAGE COUNTER
          var durationMs = end.getTime() - start.getTime();
          if (!userUsage[member]) {
            userUsage[member] = 0;
          }
          userUsage[member] += durationMs;
          console.log(member + ' total usage: ' +
            ((userUsage[member] / (1000 * 60 * 60)).toFixed(2)) + ' hours');

          // SAVE EVENTS
          saveEventsToLocalStorage();

          markCurrentlyUnavailableTools();
          document.getElementById('reservationForm').reset();
        } else {
          alert('Tool is unavailable during the selected time.');
        }
      });

      // ADMIN: ADD TOOL
      if (isAdmin) {
        document.getElementById('toolForm').addEventListener('submit', function (e) {
          e.preventDefault();
          var newTool = document.getElementById('newTool').value.trim();
          if (newTool === '') {
            alert('Tool name cannot be empty.');
            return;
          }
          if (tools.includes(newTool)) {
            alert('Tool with the same name already exists!');
          } else {
            tools.push(newTool);
            markCurrentlyUnavailableTools();
            updateRemoveToolDropdown();
            document.getElementById('toolForm').reset();
          }
        });

        // ADMIN: REMOVE TOOL
        document.getElementById('removeToolForm').addEventListener('submit', function (e) {
          e.preventDefault();
          var toolToRemove = document.getElementById('removeTool').value;
          tools = tools.filter(t => t !== toolToRemove);
          calendar.getEvents().forEach(function (ev) {
            if (ev.title.includes(toolToRemove)) {
              ev.remove();
            }
          });
          saveEventsToLocalStorage();
          markCurrentlyUnavailableTools();
          updateRemoveToolDropdown();
        });
      }

      // SYNC "Remove Tool" DROPDOWN (Admin only)
      function updateRemoveToolDropdown() {
        var removeDropdown = document.getElementById('removeTool');
        removeDropdown.innerHTML = '';
        tools.forEach(function (tool) {
          var option = document.createElement('option');
          option.value = tool;
          option.textContent = tool;
          removeDropdown.appendChild(option);
        });
      }

      // INITIALIZATION
      if (isAdmin) {
        updateRemoveToolDropdown();
      }
      setInterval(markCurrentlyUnavailableTools, 60 * 1000);

      // DOWNLOAD SNAPSHOT CSV (with usage summary)
      function downloadSnapshotCSV() {
        var view = calendar.view;
        var weekStart = view.activeStart;
        var weekEnd = view.activeEnd;
        var eventsThisWeek = [];

        calendar.getEvents().forEach(function (ev) {
          var evStart = ev.start;
          if (evStart >= weekStart && evStart < weekEnd) {
            eventsThisWeek.push(ev);
          }
        });

        eventsThisWeek.sort(function (a, b) {
          return a.start - b.start;
        });

        var csvRows = [];
        csvRows.push(['Member', 'Tool', 'Start DateTime', 'End DateTime', 'Notes'].join(','));

        if (eventsThisWeek.length === 0) {
          csvRows.push('No reservations this week,,,,');
        } else {
          function escapeForCSV(str) {
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          }
          eventsThisWeek.forEach(function (ev) {
            var parts = ev.title.split(':');
            var memberName = parts[0].trim();
            var toolAndNotes = parts[1].trim();
            var toolName = toolAndNotes.split(' - ')[0].trim();
            var notes = toolAndNotes.split(' - ')[1] || '';
            var startStr = ev.start.toLocaleString();
            var endStr = ev.end.toLocaleString();
            csvRows.push([
              escapeForCSV(memberName),
              escapeForCSV(toolName),
              escapeForCSV(startStr),
              escapeForCSV(endStr),
              escapeForCSV(notes)
            ].join(','));
          });
        }

        var usageMap = {};
        eventsThisWeek.forEach(function (ev) {
          var parts = ev.title.split(':');
          var memberName = parts[0].trim();
          var startMs = ev.start.getTime();
          var endMs = ev.end.getTime();
          var durationMs = endMs - startMs;
          if (!usageMap[memberName]) {
            usageMap[memberName] = 0;
          }
          usageMap[memberName] += durationMs;
        });

        csvRows.push(',,,,');
        csvRows.push(['Member', 'Total Hours This Week'].join(','));
        Object.keys(usageMap).forEach(function (user) {
          var hours = (usageMap[user] / (1000 * 60 * 60)).toFixed(2);
          function escapeForCSV(str) {
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          }
          csvRows.push([escapeForCSV(user), escapeForCSV(hours)].join(','));
        });

        var csvString = csvRows.join('\r\n');
        var blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        var filename =
          'schedule_snapshot_' +
          weekStart.getFullYear().toString() +
          String(weekStart.getMonth() + 1).padStart(2, '0') +
          String(weekStart.getDate()).padStart(2, '0') +
          '.csv';

        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      document.getElementById('downloadSnapshotBtn').addEventListener('click', function () {
        downloadSnapshotCSV();
      });
    });
  </script>
</body>
</html>
